# .github/workflows/ci.yml
name: Backend CI Test

# 觸發時機：當推送到 main 或 發起 Pull Request 到 main 時
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest  # 指定用 Linux 環境跑

    services:
          postgres:
            image: postgres:15
            env:
              POSTGRES_USER: user
              POSTGRES_PASSWORD: password
              POSTGRES_DB: test_db
            ports:
              - 5432:5432
            # 健康檢查：確保資料庫真的啟動好了，才開始跑測試
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
    steps:
    # 1. 把程式碼抓下來
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 設定 Python 環境 (這裡用 3.11)
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3. 安裝依賴套件 (根據你的清單)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi
        pip install psycopg2-binary pytest pytest-flask

    # 4. ★ 執行測試 (關鍵指令！)
    - name: Run Pytest
      working-directory: ./backend
      # ★ 新增下面這三行，設定環境變數
      env:
        DATABASE_URL: "postgresql://user:password@localhost:5432/test_db"
        SECRET_KEY: "dev-test-secret-key"
      run: |
        python -m pytest